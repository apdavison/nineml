<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <title>NineML WebApp</title>
    <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
    <link type="text/css" href="css/smoothness/jquery-ui.css" rel="stylesheet" />   
    <link type="text/css" href="nineml-webapp.css"            rel="stylesheet" media="all" />
    <noscript>          
        <p>Please enable JavaScript.</p>
    </noscript>         
    <script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript" src="jquery.form.js"></script>
    
    <script type="text/javascript">
        $(document).ready(function(){
            
            $("#dialogInitialPage").dialog({
                autoOpen: true,
                modal : true,
                width : 700,
                height : 500,
                buttons: {
                    "Generate AL report": function() { 
                        // Get App IOD from the server which is needed to store the input data for activity
                        var parameters = {"__NINEML_ACTION__" : "getApplicationID"};
                        $.post("nineml-webapp", parameters, function(data) {
                            var results = JSON.parse(data);
                            var success = results["success"];
                            var error   = results["error"];
                            var uuid    = results["content"];
                            if(success == true)
                            {
                                $("#applicationID").text(uuid);
                                $("#dialogInitialPage").dialog("close"); 
                                $("#dialogGenerateALReport").dialog("open");
                            }
                            else
                            {
                                alert(error);
                            }
                        });
                    },
                    
                    "Simulate Network": function() { 
                        //$(this).dialog("close"); 
                    },
                }
            });
            
            $("#dialogGenerateALReport").dialog({
                autoOpen: false,
                modal : true,
                width : 700,
                height : 500,
                buttons: {
                    "Generate": function() { 
                            $(this).dialog("close"); 
                        }, 
                    "Abort": function() { 
                            $(this).dialog("close"); 
                        } 
                    },
                open: function(event, ui) {
                        $("#testableComponent").text("");
                        $("#selectedALComponentName").text("");
                    },
                close: function(event, ui) { 
                        $("#dialogInitialPage").dialog("open"); 
                    }
            });
            
            $("#dialogSelectALComponent").dialog({
                autoOpen: false,
                modal : true,
                buttons: {
                    "Ok": function() { 
                        var component  = $("#listALComponent").val();
                        var appID      = $("#applicationID").html();
                        var parameters = {"__NINEML_ACTION__"    : "setALComponent",
                                          "__NINEML_WEBAPP_ID__" : appID,
                                          "TestableComponent" : component};
                        $.post("nineml-webapp", parameters, function(data) {
                            var results = JSON.parse(data);
                            var success = results["success"];
                            var error   = results["error"];
                            var name    = results["content"];
                            if(success == true)
                            {
                                $("#testableComponent").text(component);
                                $("#selectedALComponentName").text(component);  
                                $("#postResults").html(component);
                                $("#dialogSelectALComponent").dialog("close"); 
                            }
                            else
                            {
                                alert(error);
                                $("#dialogSelectALComponent").dialog("close"); 
                            }
                        });
                    }, 
                    "Cancel": function() { 
                        $(this).dialog("close");                         
                    } 
                },
            });

            $("#dialogUploadALComponent").dialog({
                autoOpen: false,
                modal : true,
                buttons: {
/*                    "Upload": function() { 
                        $("#applicationID").attr("applicationID", $("applicationID").text())
                        //alert('Handler for .submit() called.');
                        
                        $("#formUploadXMLFile").submit();
                        //$("#testableComponent").text(component);
                        //$("#selectedALComponentName").text(component);                        
                        //$("#formUploadXMLFile").load("nineml-webapp", parameters);
                        $(this).dialog("close"); 
                    }, */
                    "Close": function() { 
                        $(this).dialog("close");                         
                    } 
                },
            });

            $("#dialogAddTest").dialog({
                autoOpen: false,
                modal : true,
                width : 800,
                height : 600,
                buttons: {
                    "Ok": function() { 
                        var formData   = $("#formAddTest").serialize();
                        var appID      = $("#applicationID").html();
                        var parameters = {"__NINEML_ACTION__"    : "addTest",
                                          "__NINEML_WEBAPP_ID__" : appID};
                        parameters = $.param(parameters) + "&" + formData;
                        //$.extend(parameters, formData);
                        //alert(parameters);
                        $.post("nineml-webapp", parameters, function(data) {
                            var results = JSON.parse(data);
                            var success = results["success"];
                            var error   = results["error"];
                            var html    = results["content"];
                            if(success == true)
                            {
                                //alert(JSON.stringify(html));
                                $("#dialogAddTest").dialog("close");                         
                            }
                            else
                            {
                                alert(error);
                                $("#dialogAddTest").dialog("close");                         
                            }
                        });
                    },
                    "Cancel": function() { 
                        $(this).dialog("close");                         
                    } 
                }
            });

            $("#dialogAddPredefinedInputData").dialog({
                autoOpen: false,
                modal : true,
                buttons: {
                    "Continue": function() { 
                        $(this).dialog("close");                         
                    }
                },
                close: function(event, ui) { 
                        var inputData = $("#textareaInputData").val();
                        var appID      = $("#applicationID").html();
                        var parameters = {"__NINEML_ACTION__"    : "displayGUI",
                                          "__NINEML_WEBAPP_ID__" : appID,
                                          "InitialValues"        : inputData};
                        $.post("nineml-webapp", parameters, function(data) {
                            var results = JSON.parse(data);
                            var success = results["success"];
                            var error   = results["error"];
                            var html    = results["content"];
                            if(success == true)
                            {
                                $("#formAddTest").html(html);
                                $("#dialogAddTest").dialog("open");
                            }
                            else
                            {
                                alert(error);
                            }
                        });
                    }
            });

            $("#formUploadXMLFile").ajaxForm({                 
                beforeSubmit: ShowRequest,
                success: SubmitSuccesful,
                error: AjaxError                               
            });                                    

            function ShowRequest(formData, jqForm, options) {
                //$("#applicationID").attr("applicationID", "UJA")
                var queryString = $.param(formData);
                alert('BeforeSend method: \n\nAbout to submit: \n\n' + queryString);
                return true;
            }

            function AjaxError() {
                alert("An AJAX error occured.");
            }

            function SubmitSuccesful(responseText, statusText) {        
                alert("SuccesMethod:\n\n" + responseText);
            }    
            
            $("#buttonSelectALComponent").button().click(function(){
                var parameters = {"__NINEML_ACTION__" : "getAvailableALComponents"};
                $.post("nineml-webapp", parameters, function(data) {
                    var results = JSON.parse(data);
                    var success = results["success"];
                    var error   = results["error"];
                    var html    = results["content"];
                    if(success == true)
                    {
                        $("#listALComponent").html(html);
                        $("#dialogSelectALComponent").dialog("open");
                    }
                    else
                    {
                        alert(error);
                    }
                })
            });
            
            $("#buttonUploadALComponent").button().click(function(){
                $("#dialogUploadALComponent").dialog("open"); 
            });
            
            $("#buttonAddTest").button().click(function(){
                $("#dialogAddPredefinedInputData").dialog("open");
            });

        });
        
        $(window).unload(function(){
            //alert("Bye bye...");
        });
        
        String.prototype.format = function () {
            var args = arguments;
            return this.replace(/\{\{|\}\}|\{(\d+)\}/g, function (m, n) {
                if (m == "{{") { return "{"; }
                if (m == "}}") { return "}"; }
                return args[n];
            });
        }

        function addTest(name, data)
        {
            var html = "<p data=\"{0}\">{1}<button id=\"edit\">Edit</button> <button id=\"Delete\">Delete</button> </p>".format(data, name)
            $("#Tests").append(html);
        }
    </script>
</head>

<body>
<div id="dialogInitialPage" style="display:none;">
    <h1>NineML Tester</h1>
    <p>Welcome to nowhere!</p>
</div>

<div id="dialogGenerateALReport" style="display:none;" title="Generate Abstraction Layer component report">
    <div id="users-contain" class="ui-widget">
        <ol>
            <li>Choose AL component: </br>
                <button id="buttonSelectALComponent">Select predefined Component</button>
                <button id="buttonUploadALComponent">Upload component</button> </br>
                Selected AL component name: <b id="selectedALComponentName"></b>
            </li>
            <br/>
            <li>Add some tests (optional): </br>
                <table id="tests" class="ui-widget ui-widget-content">
                    <thead>
                        <tr class="ui-widget-header ">
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyDefinedTests">
                        <tr>
                            <td>John Doe</td>
                            <td>john.doe@example.com</td>
                        </tr>

                    </tbody>
                </table> </br>
                <button id="buttonAddTest">Add new test</button>
            </li>
        </ol>
        
    </div>

    </div>
    
    <div id="testableComponent" style="display:none;"></div>
</div>

<div id="applicationID" style="display:block;"></div>
<div id="postResults" style="display:block;"></div>

<div id="dialogSelectALComponent" title="Select AL Component">
    <label for="listALComponent" style="width: 200px;">NineML component:</label>
    <select id="listALComponent"></select>
</div>

<div id="dialogUploadALComponent" title="Upload AL Component">
    <form id="formUploadXMLFile" action="nineml-webapp" enctype="multipart/form-data" method="post">
<!--        <input id="applicationID" type="hidden" name="applicationID" value=""/>-->
        <input type="hidden" name="__NINEML_ACTION__" value="uploadULComponent"/>
        <label for="file">NineML User Layer XML file:</label> 
        <input id="fileXML" type="file" name="file" accept="text/xml">
        <input type="submit" value="Upload" />
    </form>
</div>

<div id="dialogAddPredefinedInputData" title="Predefined input data">
    <form id="formPredefinedInputData">
        Predefined input data (in JSON format):<br/>
        <textarea id="textareaInputData" rows="10" cols="80" style="width:100%"></textarea>
    </form>
</div>

<div id="dialogAddTest" title="Edit components parameters">
    <form id="formAddTest" action="nineml-webapp" method="post">
    </form>
<div>

<!--<form id="formReport" action="nineml-webapp" method="post">
    <div id="testableComponentName"></div>
    <div id="Tests"></div>
    <br/>
    <input id="inputAction" type="hidden" name="__NINEML_ACTION__" value=""/>
    <input id="ApplicationID" type="hidden" name="applicationID" value=""/>
    <input id="TestableComponent" type="hidden" name="TestableComponent" value=""/>
    
    <button id="buttonGenerateReport">Generate report</button>
    <button id="buttonSelectALComponent">Select AL Component</button>
    <input id="buttonAddTest" value="Add test" type="submit">
</form>
-->

</body>
</html>