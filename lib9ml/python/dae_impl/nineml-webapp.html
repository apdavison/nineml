<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <title>NineML WebApp</title>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <link type="text/css" href="script/css/redmond/jquery-ui-1.8.16.custom.css" rel="stylesheet" />   
    <link type="text/css" href="nineml-webapp.css" rel="stylesheet" media="all" />
    <script type="text/javascript" src="script/js/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="script/js/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript" src="script/jquery.form.js"></script>
    <script type="text/javascript" src="script/jquery.validate.js"></script>
    <script type="text/javascript" src="script/download.jQuery.js"></script>
    <noscript>          
        <style type="text/css">
            div {display:none;}
        </style>
        <p>You don't have javascript enabled.</p>
    </noscript>         
    <script type="text/javascript">
        $(document).ready(function(){
            
            $("#mainContent").css("display", "inline");
            
            $("#dialogInitialPage").dialog({
                autoOpen: true,
                modal : true,
                width : 700,
                height : 500,
                buttons: {
                    "Generate AL report": function() { 
                        // Get App IOD from the server which is needed to store the input data for activity
                        $("#dialogInitialPage").dialog("disable"); 
                        var parameters = {"__NINEML_ACTION__" : "getApplicationID"};
                        $.post("nineml-webapp", parameters, function(data) {
                            var results = JSON.parse(data);
                            var success = results["success"];
                            var error   = results["error"];
                            var uuid    = results["content"];
                            if(success == true)
                            {
                                $("#applicationID").text(uuid);
                                $("#dialogInitialPage").dialog("close"); 
                                $("#dialogGenerateALReport").dialog("open");
                            }
                            else
                            {
                                alert(error);
                                var traceback = results["traceback"];
                                alert(traceback);
                            }
                            $("#dialogInitialPage").dialog("enable"); 
                        });
                    },
                    
                    "Simulate Network": function() { 
                        //$(this).dialog("close"); 
                    },
                }
            });
            
            $("#dialogDownloadReport").dialog({
                autoOpen: false,
                modal : true,
                width : 450,
                height : 200,
                buttons: {
                    "Download PDF": function() { 
                        if($("#pdfAvailable").text() != "true")
                        {
                            alert("PDF report is not available");
                            return;
                        }
                        var appID      = $("#applicationID").html();
                        var parameters = {"__NINEML_ACTION__"    : "downloadPDF",
                                          "__NINEML_WEBAPP_ID__" : appID};
                        $.download("nineml-webapp", $.param(parameters));
                    }, 
                    "Download ZIP": function() { 
                        if($("#zipAvailable").text() != "true")
                        {
                            alert("ZIP archive with the test data is not available");
                            return;
                        }
                        var appID      = $("#applicationID").html();
                        var parameters = {"__NINEML_ACTION__"    : "downloadZIP",
                                          "__NINEML_WEBAPP_ID__" : appID};
                        $.download("nineml-webapp", $.param(parameters));
                    }, 
                    "Close": function() { 
                        $(this).dialog("close");                         
                    } 
                },
            });

            $("#dialogGenerateALReport").dialog({
                autoOpen: false,
                modal : true,
                width : 700,
                height : 500,
                buttons: {
                    "Generate": function() { 
                        $("#dialogGenerateALReport").dialog("disable");
                        
                        var appID      = $("#applicationID").html();
                        var parameters = {"__NINEML_ACTION__"    : "generateReport",
                                          "__NINEML_WEBAPP_ID__" : appID};
                        $.post("nineml-webapp", parameters, function(data) {
                            var results = JSON.parse(data);
                            var success = results["success"];
                            var error   = results["error"];
                            var html    = results["content"];
                            if(success == true)
                            {
                                if(results["pdfAvailable"] == true)
                                {
                                    $("#pdfAvailable").text("true");
                                }
                                if(results["zipAvailable"] == true)
                                {
                                    $("#zipAvailable").text("true");
                                }
                                $("#downloadReportMessage").text("Report generation is successsful");
                                $("#dialogDownloadReport").dialog("open");
                            }
                            else
                            {
                                var traceback = results["traceback"];
                                alert(error);
                                alert(traceback);
                            }
                            
                            $("#dialogGenerateALReport").dialog("enable");
                            //$("#dialogGenerateALReport").dialog("close"); 
                        });
                    }, 
                    "Close": function() { 
                            $(this).dialog("close"); 
                    }
                },
                open: function(event, ui) {
                        $("#testableComponent").empty();
                        $("#selectedALComponentName").empty();
                        $("#testsList").empty();
                    },
                close: function(event, ui) { 
                        $("#testableComponent").empty();
                        $("#selectedALComponentName").empty();
                        $("#testsList").empty();
                        $("#applicationID").empty();
                        
                        $("#dialogInitialPage").dialog("open"); 
                    }
            });

            $("#dialogSelectALComponent").dialog({
                autoOpen: false,
                modal : true,
                buttons: {
                    "Ok": function() { 
                        $("#dialogSelectALComponent").dialog("disable");
                        var component  = $("#listALComponent").val();
                        var appID      = $("#applicationID").html();
                        var parameters = {"__NINEML_ACTION__"    : "setALComponent",
                                          "__NINEML_WEBAPP_ID__" : appID,
                                          "TestableComponent" : component};
                        $.post("nineml-webapp", parameters, function(data) {
                            var results = JSON.parse(data);
                            var success = results["success"];
                            var error   = results["error"];
                            var name    = results["content"];
                            if(success == true)
                            {
                                $("#testableComponent").text(component);
                                $("#selectedALComponentName").text(component);  
                                $("#postResults").html(component);
                            }
                            else
                            {
                                alert(error);
                            }
                            $("#dialogSelectALComponent").dialog("enable");
                            $("#dialogSelectALComponent").dialog("close"); 
                        });
                    }, 
                    "Cancel": function() { 
                        $(this).dialog("close");                         
                    } 
                },
            });

            $("#dialogUploadALComponent").dialog({
                autoOpen: false,
                modal : true,
                buttons: {
/*                    "Upload": function() { 
                        $("#applicationID").attr("applicationID", $("applicationID").text())
                        //alert('Handler for .submit() called.');
                        
                        $("#formUploadXMLFile").submit();
                        //$("#testableComponent").text(component);
                        //$("#selectedALComponentName").text(component);                        
                        //$("#formUploadXMLFile").load("nineml-webapp", parameters);
                        $(this).dialog("close"); 
                    }, */
                    "Close": function() { 
                        $(this).dialog("close");                         
                    } 
                },
            });

            $("#dialog-message").dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    Ok: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
            
            $("#dialogInitialPageHelp").dialog({
                autoOpen: false,
                modal: true,
                width : 500,
                height : 400,
                buttons: {
                    Ok: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
            
            $("#dialogPredefinedValuesHelp").dialog({
                autoOpen: false,
                modal: true,
                width : 700,
                height : 500,
                buttons: {
                    Ok: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
            
            function showErrorMessage(message, width, height)
            {
                if(width != null)
                {
                    $("#dialog-message").dialog("option", "width", width);
                }
                if(height != null)
                {
                    $("#dialog-message").dialog("option", "height", height);
                }
                $("#dialog-message-content").html(message);
                $("#dialog-message").dialog("open");
            }
            
            function checkRegexp(name, regexp)
            {
                if ( !( regexp.test(name) ) ) 
                {
                    return false;
                } 
                else 
                {
                    return true;
                }
            }
            
            function validateForm()
            {
                $(".class_Float").each(function () {
                    var value = $(this).val();
                    if(value == "") 
                    {
                        return {"success" : false,
                                "error" : "Input field {0} cannot be empty".format($(this))};
                    } 
                    else if(isNumber(value) == false) 
                    {
                        return {"success" : false,
                                "error" : "Input field {0} must be a number".format($(this))};
                    } 
                });
                return {"success" : true};
            }
            
            function isNumber(n) {
                return !isNaN(parseFloat(n)) && isFinite(n);
            }
            
            function checkIfUnique(name)
            {
                var unique = true;
                $("#testsList").children().each(function () {
                    var child = $(this).text();
                    if(name == child) 
                    {
                        unique = false;
                    } 
                });
                return unique;
            }

            jQuery.validator.messages.required = "&nbsp; [required]";
            jQuery.validator.messages.digits   = "&nbsp; [invalid]";
            jQuery.validator.messages.number   = "&nbsp; [invalid]";
            $("#dialogAddTest").dialog({
                autoOpen: false,
                modal : true,
                width : 500,
                height : 600,
                buttons: {
                    "Ok": function() { 
                        $("#formAddTest").submit();
                    },
                    "Cancel": function() { 
                        $(this).dialog("close");                         
                    } 
                },
                open : function(event, ui) {
                        $("#errorContainer_dialogAddTest").empty();
                        $("#errorLabelContainer_dialogAddTest").empty();
                        
                        $("#formAddTest").validate(
                        {
                            errorClass: "invalid",
                            //errorContainer: "#errorContainer_dialogAddTest, #errorLabelContainer_dialogAddTest",
                            /*showErrors: function(errorMap, errorList) {
                                var message = "<b>There are " + this.numberOfInvalids() + " errors on the form.";
                                message += "<br/>Please check the fields marked in red.</b>";
                                $("#errorLabelContainer_dialogAddTest").html(message);
                                this.defaultShowErrors();
                            },*/
                            submitHandler: function() { 
                                var testName        = $("#id_testName").val();
                                var testDescription = $("#id_testDescription").val();
                                if(checkIfUnique(testName) == false)
                                {
                                    alert("Test with that name already exists.");
                                    return;
                                }
                                
                                $("#dialogAddTest").dialog("disable");                         
                                
                                var formData   = $("#formAddTest").serialize();
                                var appID      = $("#applicationID").html();
                                var parameters = {"__NINEML_ACTION__"    : "addTest",
                                                "__NINEML_WEBAPP_ID__" : appID};
                                parameters = $.param(parameters) + "&" + formData;
                                $.post("nineml-webapp", parameters, function(data) {
                                    var results = JSON.parse(data);
                                    var success = results["success"];
                                    var error   = results["error"];
                                    var json    = results["content"];
                                    if(success == true)
                                    {
                                        var testName        = $("#id_testName").val();
                                        var testDescription = $("#id_testDescription").val();
                                        var length = $("#testsList").children().length;
                                        var id = "__test_" + length;
                                        var li = "<li id=\"{0}\">{1}</li>".format(id, testName);
                                        $("#" + id).data("testName", testName);
                                        $("#" + id).data("testDescription", testDescription);
                                        $("#testsList").append(li);
                                    }
                                    else
                                    {
                                        alert(error);
                                    }
                                    $("#dialogAddTest").dialog("enable");                         
                                    $("#dialogAddTest").dialog("close");                         
                                });
                            } 
                        });
                    }
                });

            $("#dialogAddPredefinedInputData").dialog({
                autoOpen: false,
                modal : true,
                width : 600,
                height : 500,
                buttons: {
                    "Help": function() { 
                        $("#dialogPredefinedValuesHelp").dialog("open");
                    },
                    "Cancel": function() { 
                        $(this).dialog("close");                         
                    },
                    "Continue": function() { 
                        $(this).dialog("close");                         
                        
                        var inputData = $("#textareaInputData").val();
                        var appID      = $("#applicationID").html();
                        var parameters = {"__NINEML_ACTION__"    : "displayGUI",
                                          "__NINEML_WEBAPP_ID__" : appID,
                                          "InitialValues"        : inputData};
                        $.post("nineml-webapp", parameters, function(data) {
                            var results = JSON.parse(data);
                            var success = results["success"];
                            var error   = results["error"];
                            var html    = results["content"];
                            if(success == true)
                            {
                                $("#formAddTest").html(html);
                                $("#dialogAddTest").dialog("open");
                            }
                            else
                            {
                                alert(error);
                            }
                        });
                    }
                }
            });

            $("#formUploadXMLFile").ajaxForm({                 
                beforeSubmit: ShowRequest,
                success: SubmitSuccesful,
                error: AjaxError                               
            });                                    

            function ShowRequest(formData, jqForm, options) {
                //$("#applicationID").attr("applicationID", "UJA")
                var queryString = $.param(formData);
                alert("BeforeSend method: \n\nAbout to submit: \n\n" + queryString);
                return true;
            }

            function AjaxError() {
                alert("An AJAX error occured.");
            }

            function SubmitSuccesful(responseText, statusText) {        
                alert("SuccesMethod:\n\n" + responseText);
            }    
            
            $("#buttonSelectALComponent").button().click(function(){
                var parameters = {"__NINEML_ACTION__" : "getAvailableALComponents"};
                $.post("nineml-webapp", parameters, function(data) {
                    var results = JSON.parse(data);
                    var success = results["success"];
                    var error   = results["error"];
                    var html    = results["content"];
                    if(success == true)
                    {
                        $("#listALComponent").html(html);
                        $("#dialogSelectALComponent").dialog("open");
                    }
                    else
                    {
                        alert(error);
                    }
                })
            });
            
            $("#buttonUploadALComponent").button().click(function(){
                alert("Not implemented yet");
                return;
                $("#dialogUploadALComponent").dialog("open"); 
            });
            
            $("#buttonAddTest").button().click(function(){
                if($("#selectedALComponentName").text() == "")
                {
                    alert("First select/upload a component");
                    return;
                }
                $("#dialogAddPredefinedInputData").dialog("open");
            });

        });
        
        $(window).unload(function(){
            //alert("Bye bye...");
        });
        
        String.prototype.format = function () {
            var args = arguments;
            return this.replace(/\{\{|\}\}|\{(\d+)\}/g, function (m, n) {
                if (m == "{{") { return "{"; }
                if (m == "}}") { return "}"; }
                return args[n];
            });
        }
    </script>
</head>

<body>
<div id="dialogInitialPage" style="display:none;" title="NineML Web Application">
    <h3>Welcome to nowhere!</h3>
    <p>
    The web application takes a NineML component as an input and produces the component report in Latex/PDF format. 
    Optionally it can show the GUI that allows user to enter the data necessary for simulation: values of the parameters,
    initial conditions etc. Some predefined initial input values can be given in JSON format (to speed-up oftenly repeated tests).
    If no initial values are provided the GUI will be populated with zeros and defaults. <br/>
    The button <b>Generate report</b> produces the report with no test data added.<br/>
    The button <b>Add test</b> generates GUI with the data that should be entered, runs the simulation, produces results/plots
    and generates the report with the test data.<br/>
    </p>
    <p>
    The analog ports input fields accept simple numbers or expressions made with the basic mathematical functions, pi, e and numbers. <br/>
    The event ports input fields accept a comma-delimited values that represent time in seconds when the event will be triggered.
    </p>
</div>

<div id="dialogGenerateALReport" style="display:none;" title="Generate Abstraction Layer component report">
    <div id="users-contain" class="ui-widget">
        <ol>
            <li>Choose AL component: <br/>
                <button id="buttonSelectALComponent">Select predefined Component</button>
                or
                <button id="buttonUploadALComponent">Upload component</button> <br/> <br/>
                Selected AL component name: <b id="selectedALComponentName"></b>
            </li>
            <br/>
            <li id="listAddTest">Add some tests (optional): <br/>
                <ul id="testsList">
                </ul>
                <br/>
                <button id="buttonAddTest">Add test</button>
            </li>
        </ol>
        
    </div>

    </div>
    
</div>

<div id="applicationID" style="display:none;"></div>
<div id="postResults" style="display:none;"></div>
<div id="testableComponent" style="display:none;"></div>

<div id="dialogSelectALComponent" title="Select AL Component">
    <label for="listALComponent" style="width: 200px;">NineML component:</label>
    <select id="listALComponent"></select>
</div>

<div id="dialogUploadALComponent" title="Upload AL Component">
    <form id="formUploadXMLFile" action="nineml-webapp" enctype="multipart/form-data" method="post">
<!--        <input id="applicationID" type="hidden" name="applicationID" value=""/>-->
        <input type="hidden" name="__NINEML_ACTION__" value="uploadULComponent"/>
        <label for="file">NineML User Layer XML file:</label> 
        <input id="fileXML" type="file" name="file" accept="text/xml">
        <input type="submit" value="Upload" />
    </form>
</div>

<div id="dialogAddPredefinedInputData" title="Predefined input data">
    <form id="formPredefinedInputData">
        Predefined input data (in JSON format):<br/>
        <textarea id="textareaInputData" rows="30" cols="80" style="height:100%; width:100%; white-space:normal;"></textarea>
    </form>
</div>

<div id="dialogAddTest" title="Edit components parameters">
    <p id="errorLabelContainer_dialogAddTest" style="color:red;"></p>
    <ul id="errorContainer_dialogAddTest"></ul>
    <form class="cmxform" id="formAddTest" action="nineml-webapp" method="post">
    </form>
<div>

<div id="dialog-message" title="Information">
    <p id="dialog-message-content">
    </p>
</div>

<div id="dialogDownloadReport" title="Report generation results">
    <p id="downloadReportMessage"></p>
    <div id="pdfAvailable" style="display:none;"></div>
    <div id="zipAvailable" style="display:none;"></div>
</div>

<div id="dialogInitialPageHelp" title="Help">
</div>

<div id="dialogPredefinedValuesHelp" title="Help">
    <p>Some dummy input data that should work</p>
    <p><b>Component: hierachical_iaf_1coba</b> <br/>
        <code>
{
    "timeHorizon": 1.0, 
    "reportingInterval": 0.001, 
    "initial_conditions": {
        "iaf_1coba.iaf.tspike": -10000000000, 
        "iaf_1coba.iaf.V": -0.06, 
        "iaf_1coba.cobaExcit.g": 0.0
    }, 
    "parameters": {
        "iaf_1coba.iaf.gl": 50.0, 
        "iaf_1coba.cobaExcit.vrev": 0.0, 
        "iaf_1coba.cobaExcit.q": 3.0, 
        "iaf_1coba.iaf.vreset": -0.06, 
        "iaf_1coba.cobaExcit.tau": 5.0, 
        "iaf_1coba.iaf.taurefrac": 0.008, 
        "iaf_1coba.iaf.vthresh": -0.04, 
        "iaf_1coba.iaf.vrest": -0.06, 
        "iaf_1coba.iaf.cm": 1.0
    }, 
    "variables_to_report": {
        "iaf_1coba.cobaExcit.I": true, 
        "iaf_1coba.iaf.V": true
    }, 
    "event_ports_expressions": {
        "iaf_1coba.cobaExcit.spikeinput": "0.05, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90"
    }, 
    "active_regimes": {
        "iaf_1coba.cobaExcit": "cobadefaultregime", 
        "iaf_1coba.iaf": "subthresholdregime"
    }, 
    "analog_ports_expressions": {}
}
        </code>
    </p>
    
    <p><b>Component: iaf</b><br/>
        <code>
{
  "timeHorizon": 1.0, 
  "reportingInterval": 0.001, 
  "initial_conditions": {
    "iaf.tspike": -10000000000, 
    "iaf.V": -0.06
  }, 
  "parameters": {
    "iaf.gl": 50.0, 
    "iaf.vreset": -0.06, 
    "iaf.taurefrac": 0.008, 
    "iaf.vthresh": -0.04, 
    "iaf.vrest": -0.06, 
    "iaf.cm": 1.0
  }, 
  "variables_to_report": {
    "iaf.V": true
  }, 
  "event_ports_expressions": {}, 
  "active_regimes": {
    "iaf": "subthresholdregime"
  }, 
  "analog_ports_expressions": {
    "iaf.ISyn" : "1.2"
  }
}
        </code>
    </p>
            
    <p><b>Component: coba_synapse</b> <br/>
        <code>
{
  "timeHorizon": 1.0, 
  "reportingInterval": 0.001, 
  "initial_conditions": {
    "CobaSyn.g": 0.0
  }, 
  "parameters": {
    "CobaSyn.vrev": 0.0, 
    "CobaSyn.q": 3.0, 
    "CobaSyn.tau": 5.0
  }, 
  "variables_to_report": {
    "CobaSyn.I": true 
  }, 
  "event_ports_expressions": {
    "CobaSyn.spikeinput": "0.05, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90"
  }, 
  "active_regimes": {
    "CobaSyn": "cobadefaultregime"
  }, 
  "analog_ports_expressions": {
    "CobaSyn.V" : "-0.050"
  }
} 
        </code>
    </p>
</div>

</body>
</html>